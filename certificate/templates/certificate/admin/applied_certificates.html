{% extends 'users/admin/base.html' %}
{% load custom_filters %}

{% block title %}Applied Certificates{% endblock title %}

{% block content %}
<style>
    .table-responsive {
        overflow-x: auto;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        font-size: 16px;
        text-align: left;
    }
    th, td {
        padding: 12px 15px;
        border-bottom: 1px solid #ddd;
    }
    th {
        background-color: #f2f2f2;
    }
    tr:hover {
        background-color: #f5f5f5;
    }
    img {
        border-radius: 50%;
        width: 50px;
        height: 50px;
        object-fit: cover;
    }
    .table-header {
        background-color: #f2f2f2;
        font-weight: bold;
    }
    #filterForm {
        margin-top: 10px;
    }
</style>
<div class="container mt-4">
    <h2>Applied Certificates</h2>
    
    <!-- Button to Toggle Filter Form -->
    <button id="filterButton" class="btn btn-primary mb-4" type="button" onclick="toggleFilter()">Filter</button>
    
    <!-- Filter Form -->
    <div id="filterForm" style="display: none;">
        <div class="form-row">
            <div class="col">
                <select id="filterSelect" class="form-control" onchange="showInputField()">
                    <option value="">Select Filter Option</option>
                    <option value="full_name" {% if full_name_query %}selected{% endif %}>Full Name</option>
                    <option value="batch" {% if batch_query %}selected{% endif %}>Batch</option>
                </select>
            </div>
            <div class="col">
                <input type="text" id="filterInput" class="form-control" placeholder="Enter Search Query" style="display: none;" value="{{ full_name_query|default:'' }}">
            </div>
            <div class="col">
                <button id="searchButton" class="btn btn-primary" style="display: none;" onclick="submitFilter()">Search</button>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleFilter() {
        const form = document.getElementById('filterForm');
        form.style.display = form.style.display === 'none' || form.style.display === '' ? 'block' : 'none';
    }

    function showInputField() {
        const select = document.getElementById('filterSelect');
        const input = document.getElementById('filterInput');
        const searchButton = document.getElementById('searchButton');
        
        if (select.value) {
            input.style.display = 'block';
            searchButton.style.display = 'block';

            // Set input value based on the selected filter
            if (select.value === 'full_name') {
                input.value = "{{ full_name_query|default:'' }}";
            } else if (select.value === 'batch') {
                input.value = "{{ batch_query|default:'' }}";
            }
        } else {
            input.style.display = 'none';
            searchButton.style.display = 'none';
        }
    }

    function submitFilter() {
        const select = document.getElementById('filterSelect');
        const input = document.getElementById('filterInput');
        
        if (select.value && input.value) {
            const form = document.createElement('form');
            form.method = 'GET';
            form.action = window.location.href;  // Set the action to the current URL

            const hiddenSelect = document.createElement('input');
            hiddenSelect.type = 'hidden';
            hiddenSelect.name = select.value;  // Use the selected filter option
            hiddenSelect.value = input.value;   // The value entered in the input field
            
            form.appendChild(hiddenSelect);
            document.body.appendChild(form);
            form.submit();
        } else {
            alert('Please select a filter option and enter a search query.');
        }
    }
</script>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-header">
            <tr>
                <th>Full Name</th>
                <th>Student Image</th>
                <th>Course</th>
                <th>Batch</th>
                <th>Applied Date</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for application in applications %}
            <tr>
                <td>{{ application.user.full_name }}</td>
                <td>
                    {% if application.user.student_image %}
                        <img src="{{ application.user.student_image.url }}" alt="{{ application.user.full_name }}'s image">
                    {% else %}
                        <img src="" alt="No image available">
                    {% endif %}
                </td>
                <td>{{ application.course.course_name }}</td>
                <td>{{ application.batch.name }}</td>
                <td>{{ application.applied_date|date:"d M Y" }}</td>
                <td>
                    <form action="{% url 'certificate:delete-applied-certificate' application.pk %}" method="post" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this certificate?');">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </form>                        
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center">No certificates applied yet.</td>
            </tr>
            {% endfor %}
        </tbody>                  
    </table>
</div>
{% endblock content %}
