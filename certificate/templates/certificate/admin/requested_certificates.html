{% extends 'users/admin/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Requested Certificates{% endblock title %}

{% block content %}
<div class="container mt-4">
    <h2>Requested Certificates</h2>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-header">
                <tr>
                    <th>#</th>
                    <th>Student Image</th>
                    <th>Full Name</th>
                    <th>Course</th>
                    <th>Batch</th>
                    <th>Applied Date</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for application in applications %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>
                        {% if application.user.student_image %}
                            <img src="{{ application.user.student_image.url }}" alt="Image" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                        {% else %}
                            <img src="{% static 'images/default-profile.png' %}" alt="No Image" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                        {% endif %}
                    </td>
                    <td>{{ application.user.full_name }}</td>
                    <td>{{ application.course.course_name }}</td>
                    <td>{{ application.batch.name }}</td>
                    <td>{{ application.applied_date|date:"d M Y" }}</td>
                    <td>
                        <div id="action-buttons-{{ application.pk }}">
                            {% if application.status == 'Approved' %}
                                <span class="badge bg-success">Approved</span>
                            {% elif application.status == 'Rejected' %}
                                <span class="badge bg-danger">Rejected</span>
                            {% else %}
                                <button class="btn btn-sm btn-success" onclick="approveApplication({{ application.pk }})">Approve</button>
                                <button class="btn btn-sm btn-warning" onclick="rejectApplication({{ application.pk }})">Reject</button>
                            {% endif %}
                            <button class="btn btn-sm btn-danger" onclick="deleteApplication({{ application.pk }})">Delete</button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">No certificates applied yet.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function deleteApplication(id) {
        const url = `{% url 'certificate:delete-certificate-application' id %}`;
        if (confirm('Are you sure you want to delete this application?')) {
            fetch(url, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      document.getElementById(`action-buttons-${id}`).closest('tr').remove();
                      alert('Application deleted successfully.');
                  } else {
                      alert('Failed to delete application.');
                  }
              }).catch(error => alert('Error: ' + error.message));
        }
    }

    function approveApplication(id) {
        const url = `{% url 'certificate:approve-certificate-application' id %}`;
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert('Application approved successfully.');
                  location.reload();
              } else {
                  alert('Failed to approve application.');
              }
          }).catch(error => alert('Error: ' + error.message));
    }

    function rejectApplication(id) {
        const url = `{% url 'certificate:reject-certificate-application' id %}`;
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert('Application rejected successfully.');
                  location.reload();
              } else {
                  alert('Failed to reject application.');
              }
          }).catch(error => alert('Error: ' + error.message));
    }
</script>
{% endblock content %}
